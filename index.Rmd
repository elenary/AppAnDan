--- 
title: "Прикладной анализ данных"
author: "Елена Рыбина"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography:
- book.bib
- packages.bib
description: |
  Занятие по прикладному анализу данных.
link-citations: yes
github-repo: elenary/AppAnDan
---
```{r, eval=TRUE,echo=FALSE}
library(tidyverse)
library(viridis)
library(knitr)
```


```{r opts, echo = FALSE}
knitr::opts_chunk$set(fig.path = "images/")
```
# Чек-лист работы с данными

Рассмотрим, как должен выглядеть чек-лист работы с данными для проверки себя, если бы эти экспериментальные данные мы собирали бы сами?

-----Теоретический этап, планирование работы с данными-----

1. Сформулированы теоретические гипотезы.
2. Сформулированы экспериментальные гипотезы.
3. Есть понимание, как будут выглядеть собранные данные.
4. Исходя из гипотезы и того, как будут собраны и какие это данные, выбран статистический метод проверки экспериментальной гипотезы *(и хорошо, если есть понимание о статистической гипотезе -- это уже про H0 и H1)*
5. Выбрана среда для анализа данных и конкретная функция под выбранный статистический критерий (или несколько функций) *(если нужно - установлен пакет для выбранных функций)*.

-----Данные собраны-----

6. Собранные данные предобработаны и приведены в вид, к которому можно применить выбранный статистический критерий и выполнить выбранную функцию.
7. Выбранные для анализа предобработанные переменные исследованы описательными статистиками и предварительно визуализированы для общего понимания).
8. Проведен расчет выбранного статистического критерия с помощью выбранной функции.
9. Вид полученных результатов понятен для интерпретации, и результаты согласуются с представлением о том, как они должны выглядеть.
10. Результаты проинтепретированы и сделан вывод относительно статистической и экспериментальной гипотез.
11. Результаты визуализированы, так, чтобы их было легче правильно воспринять.

Теперь пройдемся подробнее по некоторым из этих пунктов.

В качестве примера возьмем датасет с kaggle <https://www.kaggle.com/datasets/uciml/student-alcohol-consumption>.
Это -- данные из двух португальских школ (скорее колледжей) с подробной социо-демографической информации о студентах, включая ту, как они учатся по математике и португальскому языку и как часто пьют алкоголь. Этот датасет я взяла, так как он содержит переменные разного типа данных в разных шкалах (и шкала отношений, например, возраст, и порядковая шкала, например, рейтинггования образования мамы или папы или поддержка в семье).

```{r, eval=TRUE}
studens_mat <- read_csv("student-mat.csv")
studens_mat %>% 
  rename_with(., ~ paste0(., "_mat"), .cols = c(absences, paid, G1, G2, G3)) -> studens_mat #переименовываю колонки для упрощения понимания, какие относятся к математикие
knitr::kable(studens_mat[1:10,]) #визуализирую табличку для этой книжки
```

```{r, eval=TRUE}
studens_por <- read_csv("student-por.csv")
studens_por %>% 
  rename_with(., ~ paste0(., "_por"), .cols = c(absences, paid, G1, G2, G3)) -> studens_por
knitr::kable(studens_por[1:10,]) #визуализирую табличку для этой книжки
```


## Сформулированы теоретические гипотезы

*<Здесь на парах мы придумывали гипотезы>*

Возьмем первую придуманную гипотезу: в датасете есть студенты возрастов от 15 до 22 двух лет. Возможно, `те, кто младше, будут бояться признаться в употрблении алкоголя и отвечать так, будто не употрябляют его`. Они вляются несовершеннолетними и могут бояться, что родители узнают.

Эта гипотеза хороша тем, что она имеет понятное теоретическое обоснование, она проверяема на наших данных, и данные подходят для того, чтобы ее проверить

Вторая гипотеза: `студенты с менее поддерживающими отношениями в семье чаще употребляют алкоголь`. Эта гипотеза так же понятна, имеет теоретическое обосноование, проверяема в исследовании, и наши данные подходят для ее проверки.


**bookdown** 
*must*
`index.Rmd`


## Сформулированы экспериментальные гипотезы

Гипотеза 1 в контексте нашего исследования и существующих переменных звучит так: `студенты возраста 15-17 лет при ответе на вопрос об употреблении алкоголя в рабочие дни (переменная Dalc) будут выбирать варианты ответов, ассоциированные с как можно более редким употреблением - 1 или 2`

Гипотеза 2 `Студенты, кто оценивает отношения с родителями как менее поддерживающие (переменная famrel, значения 1-2), чаще употребляют алкоголь (переменная Dalc, значения 4-5)`


```{r, eval=TRUE}

```

## Есть понимание, как будут выглядеть собранные данные

Здесь мы работаем с уже готовым датасетом, поэтому понимание о собранных данных у нас есть, и мы уже даже объединили несколько табличек в одну - `students`.

## Исходя из гипотезы и того, как будут собраны и какие это данные, выбран статистический метод проверки экспериментальной гипотезы

В нашем случае все не совсем так, и мы пытаемся прикрутить гипотезу к уже собранным данным -- никогда так не делайте (или делайте, но хорошо подумайте, уверены ли вы в том, что делаете?)

## Выбрана среда для анализа данных и конкретная функция под выбранный статистический критерий (или несколько функций) (если нужно - установлен пакет для выбранных функций)

Как вы уже догадались, я обрабатываю данные в R.

## Собранные данные предобработаны и приведены в вид, к которому можно применить выбранный статистический критерий и выполнить выбранную функцию

Ура, наконец-то мы на этапе, где уже собраны данные! Я немного предобработаю их, чтобы дальше было проще с ними работать. Не недооценивайте предобработку: опытные аналитики говорят, что примерно 80%-90% анализа данных составляет предобработка, и только оставшиеся -- собственно выполнение ключевой функции и получение целевой цифры.

```{r, eval=TRUE}
studens_mat %>% 
  full_join(studens_por, by = c("school","sex","age","address","famsize","Pstatus","Medu","Fedu",
                             "Mjob","Fjob","reason", "guardian", "traveltime","studytime", "failures", "schoolsup", "famsup",
                             "activities", "nursery", "higher", "internet", "romantic", "famrel", "freetime", "goout", 
                             "Dalc", "Walc", "health")) -> students #объединяю две таблички в одну
```

```{r, eval=TRUE}
students %>% 
  mutate("student" = paste0("id", row_number()), .before = "school") -> students #добавляю колонку с айдишником и перезаписываю результат в датасет
students %>% 
  drop_na() -> students #пропускаю строки с NA и перезаписываю результат в датасет
knitr::kable(students[1:10,]) 
```

```{r}
students %>% 
  mutate(G_mat = rowMeans(select(., c(G1_mat, G2_mat, G3_mat))),
         G_por = rowMeans(select(., c(G1_por, G2_por, G3_por)))) -> students
```


## Выбранные для анализа предобработанные переменные исследованы описательными статистиками и предварительно визуализированы для общего понимания)

Теперь давайте поизучаем данные. Как ведут себя выбранные для анализа переменные? Что это за данные: в какой шкале они записаны, непрерывные или дискретные? Каковы максимальные и миниамальные значения? А самые встречающиеся? Какова вообще встречаемость разных значений?

Такое описание данных называется **описательными статистиками (descipritve stats)**, потому что, как уже понятно, описывает наши данные. Это идет в разрез со **статистиками вывода (inferential stats)**, когда мы делаем выводы относительно гипотез -- сравнение двух выборов, определение предикторов в линейной регрессии и так далее. Рассмотрим описательные статистики подробнее.

### Описательные статистики
Переменные, которые нас интересовали -- для одной гипотезы это возраст (Age) и употребление алкоголя на выходных (Walc), для другой -- отношения в семье (famrel) и употребление алкоголя в рабочие дни (Dalc). Рассмотрим их подробнее.

```{r}
summary(students$age)
```
Более детальный способ -- с помощью дополнительных пакетов, например, `Skimr` и функции `skim`

```{r}
skimr::skim(students$age)
skimr::skim(students)
```

### Таблицы и пропорции

```{r}
table(students$age, students$Walc)

```

```{r}
round(prop.table(table(students$age, students$Walc), 1), 2)
```

### Описательные визуализации

Какой график построить для исследования данных внутри **одной** переменной?

**Гистограмма**

Если переменная количественная и дискретная или строковая -- гистограмму (частота встречаемости отдельных значений).

```{r}
hist(students$Walc)
```


```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=Walc)) +
  geom_histogram(binwidth = 0.5) +
  theme_minimal()

# knitr::opts_chunk$set(fig.path = "images/")
# knitr::include_graphics(rep("images/knit-logo.png", 3))

```
**График плотности вероятности**

Если переменная количественная, и данные непрерывны -- график плотности (вероятности).
В нашем датасете на количественную непрерывную переменную больше всего похожи пропуски занятий

```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=absences_por)) +
  geom_density() +
  theme_minimal()
```

```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=G_por)) +
  geom_density() +
  theme_minimal()
```

### Визуализации статистического вывода, которые тоже помогают понять данные

Хорошо, посмотрели, как ведут себя данные в наших целевых переменных: что из себя представляют, каков характер распредедения.
А что, если нам интересно посмотреть переменные не по одной, а в зависимости друг от друга? Если взять **две переменные**, по осям `x` и `y`?

**Диаграмма рассеяния**

```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=G_mat, y = absences_mat)) +
  geom_point(aes(colour = absences_mat)) +
  theme_minimal()
```

**Корроллелограммы**


**Боксплот и вайолин плот**

Если нам интересно посмотреть значения **в группах**, можно построить боксплот (тот самый ящик с усами) 

```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=Walc, y = age)) +
  geom_boxplot(aes(fill = as.factor(Walc))) +
  theme_minimal()
```

Или даже лучше и информативнее -- вайолин плот (повернутое на бок распределение плотности вероятности, зачастую вместе с ящиком с усами.)


```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=Walc, y = age)) +
  geom_violin(aes(fill = as.factor(Walc))) +
  theme_minimal()
```
**Визуализация линейной регрессии**

**Визуализация лоогистической регрессии**

#### Визуализации в R с помощью ggplot2



## Проведен расчет выбранного статистического критерия с помощью выбранной функции
Тут появится информация к занятию после майских
## Вид полученных результатов понятен для интерпретации, и результаты согласуются с представлением о том, как они должны выглядеть

## Результаты проинтепретированы и сделан вывод относительно статистической и экспериментальной гипотез
## Результаты визуализированы, так, чтобы их было легче правильно воспринять
Несмотря на то, что визуализация результатов стоит последний пунктом, это очень важный этап. Кроме того, он может использоваться и до получения результатов, чтобы прикинуть, какими  получатся результаты еще до проведения статистического теста



<!--chapter:end:index.Rmd-->


