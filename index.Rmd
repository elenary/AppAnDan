--- 
title: "Прикладной анализ данных"
author: "Елена Рыбина"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography:
- book.bib
- packages.bib
description: |
  Занятие по прикладному анализу данных.
link-citations: yes
github-repo: elenary/AppAnDan
---
```{r, eval=TRUE,echo=FALSE}
library(tidyverse)
library(viridis)
library(knitr)
library(kableExtra)
```


```{r opts, echo = FALSE}
knitr::opts_chunk$set(fig.path = "images/")
# knitr::opts_chunk$set(fig.path = "images/")
# knitr::include_graphics(rep("images/knit-logo.png", 3))
```
# Чек-лист работы с данными

Рассмотрим, как должен выглядеть чек-лист работы с данными для проверки себя, если бы эти экспериментальные данные мы собирали бы сами?

-----Теоретический этап, планирование работы с данными-----

1. Сформулированы теоретические гипотезы.
2. Сформулированы экспериментальные гипотезы.
3. Есть понимание, как будут выглядеть собранные данные.
4. Исходя из гипотезы и того, как будут собраны и какие это данные, выбран статистический метод проверки экспериментальной гипотезы *(и хорошо, если есть понимание о статистической гипотезе -- это уже про H0 и H1)*
5. Выбрана среда для анализа данных и конкретная функция под выбранный статистический критерий (или несколько функций) *(если нужно - установлен пакет для выбранных функций)*.

-----Данные собраны-----

6. Собранные данные предобработаны и приведены в вид, к которому можно применить выбранный статистический критерий и выполнить выбранную функцию.
7. Выбранные для анализа предобработанные переменные исследованы описательными статистиками и предварительно визуализированы для общего понимания).
8. Проведен расчет выбранного статистического критерия с помощью выбранной функции.
9. Вид полученных результатов понятен для интерпретации, и результаты согласуются с представлением о том, как они должны выглядеть.
10. Результаты проинтепретированы и сделан вывод относительно статистической и экспериментальной гипотез.
11. Результаты визуализированы, так, чтобы их было легче правильно воспринять.

Теперь пройдемся подробнее по некоторым из этих пунктов.

В качестве примера возьмем датасет с kaggle <https://www.kaggle.com/datasets/uciml/student-alcohol-consumption>.
Это -- данные из двух португальских школ (скорее колледжей) с подробной социо-демографической информации о студентах, включая ту, как они учатся по математике и португальскому языку и как часто пьют алкоголь. Этот датасет я взяла, так как он содержит переменные разного типа данных в разных шкалах (и шкала отношений, например, возраст, и порядковая шкала, например, рейтинггования образования мамы или папы или поддержка в семье).

```{r, eval=TRUE}
studens_mat <- read_csv("student-mat.csv")
studens_mat %>% 
  rename_with(., ~ paste0(., "_mat"), .cols = c(absences, paid, G1, G2, G3)) -> studens_mat #переименовываю колонки для упрощения понимания, какие относятся к математикие
kable(studens_mat[1:10,]) %>% scroll_box(width = "100%") #визуализирую табличку для этой книжки
```

```{r, eval=TRUE, results = "asis"}
studens_por <- read_csv("student-por.csv")
studens_por %>% 
  rename_with(., ~ paste0(., "_por"), .cols = c(absences, paid, G1, G2, G3)) -> studens_por
kable(studens_por[1:10,]) %>% scroll_box(width = "100%") #визуализирую табличку для этой книжки
```


## Сформулированы теоретические гипотезы

*<Здесь на парах мы придумывали гипотезы>*

Возьмем первую придуманную гипотезу: в датасете есть студенты возрастов от 15 до 22 двух лет. Возможно, `те, кто младше, будут бояться признаться в употрблении алкоголя и отвечать так, будто не употрябляют его`. Они вляются несовершеннолетними и могут бояться, что родители узнают.

Эта гипотеза хороша тем, что она имеет понятное теоретическое обоснование, она проверяема на наших данных, и данные подходят для того, чтобы ее проверить

Вторая гипотеза: `студенты с менее поддерживающими отношениями в семье чаще употребляют алкоголь`. Эта гипотеза так же понятна, имеет теоретическое обосноование, проверяема в исследовании, и наши данные подходят для ее проверки.

У меня была еще одна, третья гипотеза: что `студенты, пропускающие много занятий, буду иметь более низкий средний балл по математике и португальскому`.

## Сформулированы экспериментальные гипотезы

Гипотеза 1 в контексте нашего исследования и существующих переменных звучит так: `студенты возраста 15-17 лет (переменная age) при ответе на вопрос об употреблении алкоголя в выходные дни (переменная Walc) будут выбирать варианты ответов, ассоциированные с как можно более редким употреблением - 1 или 2`

Гипотеза 2 `Студенты, кто оценивает отношения с родителями как менее поддерживающие (переменная famrel, менее поддерживающие в значениях 1-2), чаще употребляют алкоголь (переменная Walc, возьмем тоже выходные дни, значения 4-5)`

Гипотеза 3 `Студенты, у кого было много пропусков (переменная absences_mat или absences_por, высокие значения), будут иметь более низкий средний балл (среднее из переменных G1_mat, G2_mat, G3_mat или G1_por, G2_por, G3_por -- низкие значения)`

Давайте сначала подумаем, что это за гипотезы, какие зависимые и независимые переменные, наличие или отсутствие какой связи между зависимой и независимыми переменными нам хочется проверить?

### Зависимые (ЗП) и независимые (НП) переменные в гипотезе

Рассмотрим гипотезу 1. Что в ней является зависимой и независимой переменной? 

#### Что из переменных зависимая и независимая

Сейчас гипотеза сформулирована так, что НП -- это возраст (age), а ЗП -- это количество употребления алкоголя Walc. Согласны ли вы с таким разделением? Почему?
Иногда бывает сложно определить, что будет являться зависимой и независимыми переменными. Независимые переменные -- это все, чем мы манипулируем по ходу проведения исследования, с целью получить разный результат. Зависимая -- целевая переменная, то, что мы измереяем, изменения в чем мы ожидаем получить после манипуляции независимыми переменными.
При описании исследования всегда важно записывать ЗП и НП, наряду с экспериментальной (эмпирической) гипотезой -- сердце нашего исследования, самое основное из языка, на котором описывается исследование.

Следующий вопрос -- к какой шкале относятся ЗП и НП? Это важно понимать, чтобы потом выбрать, как анализировать данные.

#### Типы шкал

Шкала | Описание | Возможные операции | Примеры  | 
------| ---------| ------------------ | -------- | 
**Наименований (номинальная)** | Качественная, нельзя установить "больше или меньше" | =, $\neq$ | shcool, sex, address, famsize, Mjob, Fjob, schoolsup | 
**Порядка (ранговая)**         | Качественная, можно установить "больше или меньше", но нельзя посчитать его количественно, на сколько больше или меньше | =, $\neq$, >, < | Medu, Fedu, traveltime, studytime, famrel, freetime, goout, Dalc, Walc, health | 
**Разности (интервальная)**    | Количественная, но нет абсоолютного нуля, можно посчитать  *на сколько* больше или меньше, но нельзя посчитать, *во сколько раз* | =, $\neq$, >, <, +, - | G *(отнесу сюда, так как с оценками все сложно)*  | 
**Отношений (абсолютная)**     | Количественная, есть абсолютный ноль, можно посчитать и *на сколько* больше или меньше, и *во сколько раз* | =, $\neq$, >, <, +, -, ×, ÷ | age, failures, absences | 

Опишем переменные для гипотезы 1. Возраст (age) -- это количественная переменная, в целом про возраст мы можем сказать, что он непрерывен (здесь возраст округлен до целых, поэтому на которотком промежутке возрастов это может сыграть роль) Чуть позже посмотрим на переменную возраста в описательных статистиках, чтобы убедиться, что можем работать с ней как с непрерывной переменной. У возраста есть абсолютный ноль (нельзя быть возраста "-10 лет"), можем сказать, что человек возраста 30 лет в два раза старше человека возраста 15 лет, поэтому возраст относится к шкале отношений.

Walc -- явно относится к порядковой шкале: можем сказать, что студенты, ответившие "4" на вопрос про употребление алкоголя, употребляют его больше, чем те, кто выбрал "2", но не можем сказать, что в количестве выпитого алкоголя эта разница выражается как в два раза больше.

*К каким шкалам относятся переменные для гипотезы 2 и гипотезы 3?*

### Связь между ЗП и НП: какая она?

Сейчас гипотеза 1 сформулирована так:
> `студенты возраста 15-17 лет (переменная age) при ответе на вопрос об употреблении алкоголя в выходные дни (переменная Walc) будут выбирать варианты ответов, ассоциированные с как можно более редким употреблением - 1 или 2`

Мы выяснили, что НП -- это возраст (age), а ЗП -- это количество употребления алкоголя Walc. То есть, разворачивая такую формулировку, мы считаем, что возраст влияет на отеты. Можем ли мы проверить такую причинно-следственную связь в этих данных?

Два осноовных вида связи между переменными:

* Ассоциативная или корреляционная
* Причинно-следственная

Три необходимых условия для установления причинно-следственной связи:
* 
* 
* 

Получается, что установить причинно-следственную связь таким образом не получится, и мы можем говорить о корруляционной или ассоциативной связи. Кажется, отсюда следует, что мы можем говорить только о корреляции, однако, тут тоже есть варианты. Сравните гипотезы: `чем меньше возраст студентов (age), чем ниже будут ответы в переменной Walc` и `студенты возраста 15, 16, 17 лет будут выбирать низкие варианты ответа в переменной Walc`. Чем они отличаются?

#### Уровни ЗП и НП

Следующий вопрос про НП и ЗП -- это какие уровни есть в переменных? Обычно об уровнях переменных говорят, когда есть несколько условий внутри одной переменной, например, условия "часто" и "редко", условия "обеспеченная семья" "не обеспеченная". Вопрос уровней тесно связан с вопросом о связи между переменными и деталями гипотезы.


## Есть понимание, как будут выглядеть собранные данные

Здесь мы работаем с уже готовым датасетом, поэтому понимание о собранных данных у нас есть. Но в реальной жизни прежде, чем начинать сбор данных, нужно хорошо представлять себе, как будут записываться данные: это логи  в текстовом файле, и нам нужно будет вручную выковыривать цифры и собирать табличку? Если да, можно ли это автоматизировать? Или это эксель-табличка, в которую данные будут писаться в уже пригодном для работы виде? Если нет, можем ли мы сделать что, чтобы данные писались в такую удобную табличку еще на этапе кодирования эксперимента?

## Исходя из гипотезы и того, как будут собраны и какие это данные, выбран статистический метод проверки экспериментальной гипотезы

В нашем случае все не совсем так, и мы на уже готовом датасете пытаемся восстановить изначальные гипотезы, для проверки которых этот датасет собирался. Вообще пытаться прикрутить гипотезу к уже собранным данным --  это **плохая научная практика**, которая приводит к большому числу ложноположительных результатов. Об этом мы тоже будем говорить на одном из семинаров. 


## Выбрана среда для анализа данных и конкретная функция под выбранный статистический критерий (или несколько функций) (если нужно - установлен пакет для выбранных функций)

Как вы уже догадались, я обрабатываю данные в R. 
*Этот сайт, кстати, тоже сделан на языке R в RStudio с помощью текстовой разметки RMarkdown. Об этом мы тоже немного поговорим на последнем семинаре, когда будем говорить про презентации результатов*

## Собранные данные предобработаны и приведены в вид, к которому можно применить выбранный статистический критерий и выполнить выбранную функцию

Ура, наконец-то мы на этапе, где уже собраны данные! Я немного предобработаю их, чтобы дальше было проще с ними работать. Не недооценивайте предобработку: опытные аналитики говорят, что примерно 80%-90% анализа данных составляет предобработка, и только оставшееся -- собственно вычисление ключевой функции (статистического критерия) и получение целевой цифры.

```{r, eval=TRUE}
studens_mat %>% 
  full_join(studens_por, by = c("school","sex","age","address","famsize","Pstatus","Medu","Fedu",
                             "Mjob","Fjob","reason", "guardian", "traveltime","studytime", "failures", "schoolsup", "famsup",
                             "activities", "nursery", "higher", "internet", "romantic", "famrel", "freetime", "goout", 
                             "Dalc", "Walc", "health")) -> students #объединяю две таблички в одну
```

```{r, eval=TRUE}
students %>% 
  mutate("student" = paste0("id", row_number()), .before = "school") -> students #добавляю колонку с айдишником и перезаписываю результат в датасет
students %>% 
  drop_na() -> students #пропускаю строки с NA и перезаписываю результат в датасет
```

```{r}
students %>% 
  mutate(G_mat = rowMeans(select(., c(G1_mat, G2_mat, G3_mat))),
         G_por = rowMeans(select(., c(G1_por, G2_por, G3_por)))) -> students
kable(students[1:10,]) %>% scroll_box(width = "100%") #здесь я посчитала средний балл по трем баллам по математике G_mat и португальскому G_por 
```

## Выбранные для анализа предобработанные переменные исследованы описательными статистиками и предварительно визуализированы для общего понимания)

Теперь давайте поизучаем данные. Как ведут себя выбранные для анализа переменные? Что это за данные: в какой шкале они записаны, непрерывные или дискретные? Каковы максимальные и миниамальные значения? А самые встречающиеся? Какова вообще встречаемость разных значений?

Такое описание данных называется **описательными статистиками (descipritve stats)**, потому что, как уже понятно из названия, описывает наши данные. Это идет в разрез со **статистиками вывода (inferential stats)**, когда мы делаем выводы относительно гипотез -- сравнение двух выборок с определением статистической значимости результатов, корреляционный тест, определение коэффциентов в линейной регрессии и так далее. Сейчас нас интересует исследование самих переменных, поэтому речь пойдет об описательные статистики подробнее.

### Описательные статистики
Переменные, которые нас интересовали -- для одной гипотезы это возраст (Age) и употребление алкоголя на выходных (Walc), для другой -- отношения в семье (famrel) и употребление алкоголя в рабочие дни (Dalc). Рассмотрим их подробнее. И еще дл

```{r}
summary(students$age)
```
Более детальный способ -- с помощью дополнительных пакетов, например, `Skimr` и функции `skim`

```{r}
skimr::skim(students$age)
skimr::skim(students)
```

### Таблицы и пропорции

```{r}
table(students$age, students$Walc)

```

```{r}
round(prop.table(table(students$age, students$Walc), 1), 2)
```

### Описательные визуализации

Какой график построить для исследования данных внутри **одной** переменной?

**Гистограмма**

Если переменная количественная и дискретная или строковая -- гистограмму (частота встречаемости отдельных значений).

```{r}
hist(students$Walc)
```


```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=Walc)) +
  geom_histogram(binwidth = 0.5) +
  theme_minimal()

```

Другой вариант визуализации гистограммы -- с помощью барплота.

**Барплоты**

```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=Walc)) +
  geom_bar(aes(fill = as.factor(Walc)), stat = 'count') +
  theme_minimal()
```
Сейчас мы нарисовали точно такую же диаграмму, но с помощью атрибута `geom_bar` вместо `geom_histogram` функции `ggplot`. Гистограммного вида мы добились с помощью значения `count` атрибута `stat`. Этот атрибут означает, что вместо барплота, который строится по двум переменным `x` и `y`, мы будем строить график количества значений (гистограмму) для одной переменной `x`. Другой популярный вариант значения атрибута `stat` - значение `identity`, буквально означает "строим барплот как есть, по двум переменным":
```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=as.factor(Walc), y = as.factor(age))) +
  geom_bar(aes(), stat = 'identity') +
  theme_minimal()
```
Здесь я еще сделала преобразование `as.factor` для переменной `age`. 

```{r, eval=TRUE}
students %>% 
  ggplot(aes(x = as.factor(age), y = as.factor(Walc))) +
  geom_bar(aes(fill = as.factor(Walc)), stat = 'identity') +
  theme_minimal()
```

**График плотности вероятности**

Если переменная количественная, и данные непрерывны -- график плотности (вероятности).
В нашем датасете на количественную непрерывную переменную больше всего похожи пропуски занятий

```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=absences_por)) +
  geom_density() +
  theme_minimal()
```

```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=G_por)) +
  geom_density() +
  theme_minimal()
```

### Визуализации статистического вывода, которые тоже помогают понять данные

Хорошо, посмотрели, как ведут себя данные в наших целевых переменных: что из себя представляют, каков характер распредедения.
А что, если нам интересно посмотреть переменные не по одной, а в зависимости друг от друга? Если взять **две переменные**, по осям `x` и `y`?

Такие графики мы обычно строим, когда нужно визуализироовать результаты какого-либо статистического тестирования: сравнения двух средних, поиска корреляции и т.д. Поэтому я назвала этот пункт "визуализациями статистического вывода". Однако, сами статистические тесты сейчас я не провожу, но мне интересно взглянуть на данные, как они ведут себя уже не сами по себе, а в соответствии с выдвинутыми гипотезами?

**Диаграмма рассеяния**

```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=G_mat, y = absences_mat)) +
  geom_point(aes(colour = absences_mat)) +
  theme_minimal()
```

**Коррелограмма**

Допустим, мы хотим посмотреть корреляцию всех количественных переменных соо всеми (никогда так не делайте -- вы обязательно найдетете какую-нибудь связь, возможно из-за статистической ошибки и несмотря на то, что не искали эту связь, и соблазн выдать ее за свою гипотезу будет слишком велик).
```{r}
students %>% 
  select(traveltime, studytime, famrel, freetime, Dalc, Walc, health, absences_mat, absences_por, G_mat, G_por) %>% 
  as.matrix() -> students_numeric_matrix
```


```{r}
students_numeric_matrix %>% 
  cor() %>% 
  round(2)
```
Или более красивый и понятный вариант с помощью пакета `Hmisc`

```{r}
library("Hmisc")
students_numeric_matrix %>%  
  rcorr() 
```

Визуализируем матрицу корреляций в коррелограмму


```{r}
library(corrplot)
corrplot(cor(students_numeric_matrix), method="circle")
# corrplot(rcorr(students_numeric_matrix)$r, p.mat = rcorr(students_numeric_matrix)$P, sig.level = 0.05, insig = "blank")
```

```{r}
heatmap(x = cor(students_numeric_matrix))
```


**Боксплот и вайолин плот**

Если нам интересно посмотреть значения **в группах**, можно построить боксплот (тот самый ящик с усами) 

```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=Walc, y = age)) +
  geom_boxplot(aes(fill = as.factor(Walc))) +
  theme_minimal()
```

Или даже лучше и информативнее -- вайолин плот (повернутое на бок распределение плотности вероятности, зачастую вместе с ящиком с усами.)


```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=Walc, y = age)) +
  geom_violin(aes(fill = as.factor(Walc))) +
  theme_minimal()
```


**Визуализация линейной регрессии**

```{r, eval=TRUE}
students %>% 
  # slice(absences_mat<40) %>% 
  ggplot(aes(x=absences_mat, y = G_mat)) +
  geom_point(aes(colour = absences_mat)) +
  geom_smooth(method="lm") +
  theme_minimal()
```

**Визуализация логистической регрессии**

### Визуализации в R с помощью ggplot2

**Грамматика графиков (The Crammar of Graphics)**

Большую часть этих графиков я визуализировала с помощью пакета `ggplot2`. Пару слов о том, как он работает.
<https://ggplot2.tidyverse.org/>

По сути, это -- универсальный конструктор графиков. Мы подгружаем данные, а дальше, послойно, собираем на них график как конструктор, накладывая каждый слой на предыдущий. В парадигме грамматики графиков любой график состоит из нескольких слоев:

* первый слой -- данные, передаем их чаще всего первой строчкой с объявлением функции `ggplot()`
* geom (геометрический объект), обычно второй строчкой: geom_hist, geom_bar, geom_point, geom_line
* aes (эстетики) - аргумент geom или ggplot -- оси x и y, цвета (для обводки и точек цвет задает через color, для заливки и объектов, имеющих плозадь -- через fill). Пишут внутри aes() в скобках внутри геома или ggplot. Задавая аргументы-эстетики как бы *натягиваем* наши данные на координатную ось и геометрический объект, задаем правила преообразования данных в график.
Это были обязательные слои построения графиков. Есть еще вспомогательные, которые доступны не для всех геомов:

* stat (статистические трансформации) - используется в основном для превращения барплота в гистограмму (stat="count")
* facets - позволяет отобразить график в фасетах
* themes - настраивает визуальные темы (вне зависимости от данных и геома: цвет фона графика, прозрачность подложки, толщина и цвет координатной сетки и т.д.)

## Проведен расчет выбранного статистического критерия с помощью выбранной функции



## Вид полученных результатов понятен для интерпретации, и результаты согласуются с представлением о том, как они должны выглядеть

## Результаты проинтепретированы и сделан вывод относительно статистической и экспериментальной гипотез

## Результаты визуализированы, так, чтобы их было легче правильно воспринять
Несмотря на то, что визуализация результатов стоит последний пунктом, это очень важный этап. Кроме того, он может использоваться и до получения результатов, чтобы прикинуть, какими  получатся результаты еще до проведения статистического теста

###  Визуализации данных в системах для построения дашбордов

<https://www.tableau.com/>
<https://www.tableau.com/data-insights/dashboard-showcase>
<https://www.datawrapper.de/>

<!--chapter:end:index.Rmd-->


